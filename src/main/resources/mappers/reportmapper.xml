<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

	

<mapper namespace="com.example.DAO.ReportRepository">

 <select id="getAllReports" resultType="ReportVO">
  SELECT
    r.report_id      AS reportId,
    r.reporter_id    AS reporterId,
    r.target_user_id AS targetUserId,
    r.reason,
    r.status,
    r.created_at     AS createdAt,
    rep.nickname     AS reporterNickname,
    tgt.nickname     AS targetNickname,
    tgt.login_id     AS targetLoginId, 
    tgt.is_banned    AS targetBanned,
    (
      SELECT COUNT(*)
      FROM report
      WHERE target_user_id = r.target_user_id
    ) AS reportCount
  FROM report r
  JOIN member rep      ON r.reporter_id    = rep.user_id
  LEFT JOIN member tgt ON r.target_user_id = tgt.user_id
  ORDER BY r.created_at DESC
</select>


 



	<select id="getTopReportedUsers" resultType="ReportVO">
 SELECT
    r.target_user_id AS targetUserId,
    m.nickname       AS targetNickname,
    COUNT(DISTINCT r.reporter_id) AS reportCount,
    m.is_banned      AS targetBanned
  FROM report r
  JOIN member m ON m.user_id = r.target_user_id
  WHERE r.target_user_id IS NOT NULL
  GROUP BY r.target_user_id, m.nickname, m.is_banned
  ORDER BY reportCount DESC
  LIMIT 3
</select>


<select id="countReportsByTarget" parameterType="int" resultType="int">
  SELECT COUNT(*)
  FROM `report`
  WHERE target_user_id = #{targetUserId}
</select>

<update id="updateReportStatus">
  UPDATE report
  SET status = #{status}
  WHERE report_id = #{reportId}
</update>


<select id="getReportById" parameterType="int" resultType="ReportVO">
  SELECT
    r.report_id        AS reportId,
    r.reporter_id      AS reporterId,
    r.target_user_id   AS targetUserId,
    r.report_type      AS reportType,
    r.reason_code      AS reasonCode,
    r.reason           AS reason,
    r.status           AS status,
    r.created_at       AS createdAt,
    r.chat_message_mongo_id  AS chatMessageMongoId,
    r.ban_days         AS banDays,
    r.ban_reason       AS banReason,
    r.ban_expire_at    AS banExpireAt,
    r.appeal_requested AS appealRequested,

    rep.nickname       AS reporterNickname,
    tgt.nickname       AS targetNickname,
    tgt.login_id       AS targetLoginId,
    tgt.is_banned      AS targetBanned,

    (
      SELECT COUNT(*)
      FROM report
      WHERE target_user_id = r.target_user_id
    ) AS reportCount

  FROM report r
  JOIN member rep      ON r.reporter_id = rep.user_id
  LEFT JOIN member tgt ON r.target_user_id = tgt.user_id
  WHERE r.report_id = #{reportId}
</select>


<insert id="insertReport" parameterType="ReportVO">
  INSERT INTO report (
    reporter_id,
    target_user_id,
    chat_message_mongo_id,  <!-- 추가 -->
    reason,
    report_type,
    created_at
  ) VALUES (
    #{reporterId},
    #{targetUserId},
    #{chatMessageMongoId, jdbcType=VARCHAR},  <!-- 추가 -->
    #{reason},
    #{reportType},
    NOW()
  )
</insert>


</mapper>
